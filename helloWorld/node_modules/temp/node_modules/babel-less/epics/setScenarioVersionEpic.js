import { SET_SCENARIO_VERSION } from '../constants/actionTypes';
import {
  SCENARIO_FILE_VERSION,
  SCENARIO_ID,
  DELTA_COMMENT,
} from '../constants/stateConstants';
import batchManagementApiFactory from '../shared/batchManagementApiFactory';
import requestScenarioVersionsAction from '../actions/requestScenarioVersionsAction';

const setScenarioVersionEpic = (action$, { getState }) =>
  action$.ofType(SET_SCENARIO_VERSION).mergeMap($action => {
    const api = batchManagementApiFactory(getState());

    const id = $action.payload[SCENARIO_ID];
    const deltaComment = $action.payload[DELTA_COMMENT];
    const scenarioFileVersion = $action.payload[SCENARIO_FILE_VERSION];

    const apiStream = api
      .setScenarioVersion(id, scenarioFileVersion, deltaComment)
      .map(result => requestScenarioVersionsAction(id));

    return apiStream;
  });

export default setScenarioVersionEpic;
